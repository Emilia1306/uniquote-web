<div class="mx-auto max-w-[1400px] px-6 py-6">
  <!-- Encabezado -->
  <h1 class="text-3xl font-semibold text-[color:var(--accent-600)]">Usuarios</h1>
  <p class="muted mb-4">Gestiona los usuarios del sistema</p>

  <!-- Filtros -->
  <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-5 items-center">
    <!-- Buscador -->
    <div class="md:col-span-7">
      <label class="sr-only" for="users-search">Buscar</label>
      <div class="relative">
        <input id="users-search"
          class="w-full rounded-lg border border-zinc-300 bg-white px-4 py-2 pr-10 outline-none focus:border-zinc-500"
          [ngModel]="_searchRaw()" (ngModelChange)="onSearchChange($event)"
          placeholder="Buscar por nombre, apellido o correo" />
        <lucide-angular name="search"
          class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 opacity-60"></lucide-angular>
      </div>
    </div>

    <!-- Dropdown de roles (custom) -->
    <div class="md:col-span-3 relative">
      <button type="button"
        class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-left flex items-center justify-between focus:border-zinc-500"
        (click)="toggleRoleDropdown()" aria-haspopup="listbox" [attr.aria-expanded]="isRoleOpen()">
        <span>{{ roleLabel(roleFilter()) }}</span>
        <lucide-angular name="chevron-down" class="opacity-60"></lucide-angular>
      </button>

      <ul *ngIf="isRoleOpen()" role="listbox" class="absolute z-50 mt-2 w-full rounded-xl border border-zinc-200 bg-white shadow-lg p-2
                 max-h-56 overflow-auto overscroll-contain">
        <li *ngFor="let r of roleOptions" role="option" (click)="setRole(r)"
          class="px-3 py-2 rounded-lg cursor-pointer flex items-center gap-2 hover:bg-[var(--peach-75)]"
          [class.text-[color:var(--accent-600)]]="roleFilter()===r">
          <span class="text-sm">{{ roleLabel(r) }}</span>
        </li>
      </ul>
    </div>

    <!-- Botón nuevo -->
    <div class="md:col-span-2">
      <button class="w-full md:w-auto rounded-lg bg-[var(--accent-600)] px-4 py-2 text-white hover:opacity-90"
        (click)="openCreate()">
        + Nuevo usuario
      </button>
    </div>
  </div>

  <!-- Tabla -->
  <div class="rounded-lg border border-zinc-200 bg-white overflow-hidden">
    <table class="w-full text-sm">
      <thead class="bg-zinc-50">
        <tr class="text-left">
          <th class="p-3">Nombre</th>
          <th class="p-3">Apellido</th>
          <th class="p-3">Correo</th>
          <th class="p-3">Rol</th>
          <th class="p-3 w-32"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of paged()" class="border-t">
          <td class="p-3">{{ u.name }}</td>
          <td class="p-3">{{ u.lastName }}</td>
          <td class="p-3">{{ u.email }}</td>
          <td class="p-3">
            <!-- Chips del rol como en dashboard -->
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold text-white"
              [ngClass]="{
                'bg-red-500': u.role==='ADMIN',
                'bg-orange-500': u.role==='GERENTE',
                'bg-amber-500': u.role==='DIRECTOR'
              }">
              {{ u.role | titlecase }}
            </span>
          </td>
          <td class="p-3 text-right">
            <!-- Editar -->
            <button type="button" class="inline-flex h-9 w-9 items-center justify-center rounded-full
                     text-[color:var(--accent-600)]
                     hover:bg-[var(--peach-75)] focus:outline-none focus-visible:ring-2
                     ring-[color:var(--accent-600)] transition" (click)="openEdit(u)" aria-label="Editar usuario"
              title="Editar">
              <lucide-angular name="pencil" class="h-4 w-4"></lucide-angular>
            </button>
            <!-- Eliminar -->
            <button type="button" class="inline-flex h-9 w-9 items-center justify-center rounded-full
                     text-[color:var(--accent-600)]
                     hover:bg-[var(--peach-75)] focus:outline-none focus-visible:ring-2
                     ring-[color:var(--accent-600)] transition ml-1.5" (click)="remove(u)"
              aria-label="Eliminar usuario" title="Eliminar">
              <lucide-angular name="trash-2" class="h-4 w-4"></lucide-angular>
            </button>
          </td>
        </tr>

        <tr *ngIf="!loading() && paged().length === 0">
          <td class="p-6 text-center text-zinc-500" colspan="5">Sin resultados</td>
        </tr>
        <tr *ngIf="loading()">
          <td class="p-6 text-center text-zinc-500" colspan="5">Cargando…</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Footer: contador + paginado -->
  <div class="mt-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div class="text-sm text-zinc-600">
      {{ (filtered().length === 0) ? '0 – 0' : (startIndex() + 1) + ' – ' + endIndex() }} de {{ filtered().length }}
    </div>

    <ng-container *ngIf="totalPages() > 1">
      <div class="flex items-center gap-3">
        <button class="px-4 py-2 rounded-full border border-zinc-200 text-zinc-700 disabled:opacity-50"
          [disabled]="!hasPrev()" (click)="prevPage()" aria-label="Página anterior">Prev</button>

        <div class="flex items-center gap-2">
          <button *ngFor="let i of pagesArray()" class="h-8 w-8 rounded-full border border-zinc-200 text-sm"
            [class.bg-[var(--accent-600)]]="page() === i" [class.text-white]="page() === i"
            [class.text-zinc-600]="page() !== i" (click)="goPage(i)" [attr.aria-current]="page() === i ? 'page' : null">
            <span class="sr-only">Página {{ i + 1 }}</span>
          </button>
        </div>

        <button class="px-4 py-2 rounded-full border border-zinc-200 text-zinc-700 disabled:opacity-50"
          [disabled]="!hasNext()" (click)="nextPage()" aria-label="Página siguiente">Next</button>
      </div>
    </ng-container>
  </div>

  <!-- Modal crear/editar (backdrop-click para cerrar) -->
  <div *ngIf="showForm()" class="fixed inset-0 z-50 grid place-items-center bg-black/40 p-4" (click)="cancelForm()">
    <div class="bg-white w-full max-w-3xl rounded-3xl shadow-2xl overflow-hidden" (click)="$event.stopPropagation()">

      <!-- Header -->
      <div class="px-6 py-5 border-b">
        <h2 class="text-2xl font-semibold">
          {{ editingId() ? 'Editar usuario' : 'Nuevo usuario' }}
        </h2>
      </div>

      <!-- Body scrolleable -->
      <div class="px-6 py-6 max-h-[80vh] overflow-y-auto overscroll-contain">
        <form class="space-y-6" (submit)="$event.preventDefault()">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm mb-1">Nombre</label>
              <input class="input w-full" [(ngModel)]="f.name" name="name" required />
            </div>
            <div>
              <label class="block text-sm mb-1">Apellido</label>
              <input class="input w-full" [(ngModel)]="f.lastName" name="lastName" required />
            </div>
          </div>

          <div>
            <label class="block text-sm mb-1">Correo</label>
            <input class="input w-full" type="email" [(ngModel)]="f.email" name="email" required />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm mb-1">Teléfono (opcional)</label>
              <input class="input w-full" [(ngModel)]="f.phone" name="phone" />
            </div>
            <div>
              <label class="block text-sm mb-1">Contraseña (opcional al editar)</label>
              <input class="input w-full" type="password" [(ngModel)]="f.password" name="password"
                [required]="!editingId()" />
            </div>
          </div>

          <!-- Dropdown custom del rol -->
          <div class="relative">
            <label class="block text-sm mb-1">Rol</label>

            <button type="button" #roleBtn class="w-full rounded-lg border border-zinc-300 bg-white px-3 py-2 text-left
                     flex items-center justify-between focus:border-zinc-500" (click)="toggleFormRole(roleBtn)">
              <span>{{ formRoleLabel() }}</span>
              <lucide-angular name="chevron-down" class="opacity-60"></lucide-angular>
            </button>

            <!-- Menú (no provoca scroll del contenedor) -->
            <ul *ngIf="isFormRoleOpen()" class="absolute z-[60] w-full rounded-xl border border-zinc-200 bg-white shadow-xl p-2
                       max-h-60 overflow-auto overscroll-contain" [ngClass]="{
                  'top-full mt-2': formRolePlacement()==='down',
                  'bottom-full mb-2': formRolePlacement()==='up'
                }" (wheel)="$event.stopPropagation()">
              <li *ngFor="let opt of formRoleOptions" (click)="pickFormRole(opt.id)" class="px-3 py-2 rounded-lg cursor-pointer hover:bg-[var(--peach-75)]
                         flex items-center gap-2" [class.text-[color:var(--accent-600)]]="f.roleId===opt.id">
                {{ opt.label }}
              </li>
            </ul>
          </div>
        </form>
      </div>

      <!-- Footer sticky -->
      <div class="sticky bottom-0 bg-white border-t px-6 py-4 flex justify-end gap-3">
        <button type="button" class="h-10 px-5 rounded-full bg-zinc-100 text-zinc-700 hover:bg-zinc-200"
          (click)="cancelForm()">Cancelar</button>
        <button class="h-10 px-5 rounded-full bg-orange-600 text-white hover:bg-orange-700 disabled:opacity-50"
          (click)="submit()" [disabled]="loading()">
          {{ loading() ? 'Guardando…' : 'Guardar' }}
        </button>
      </div>
    </div>
  </div>
</div>