<div class="page">
  <!-- Encabezado -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-[color:var(--brand)] mb-1">Usuarios</h1>
    <p class="text-zinc-500">Gestiona los usuarios del sistema</p>
  </div>

  <!-- Toolbar -->
  <div class="flex flex-col md:flex-row gap-4 mb-8">
    <!-- Buscador -->
    <div class="relative flex-1">
      <input
        class="w-full h-12 rounded-xl border border-zinc-200 bg-white px-5 pr-12 outline-none focus:border-zinc-400 focus:ring-0 shadow-sm"
        [ngModel]="_searchRaw()" (ngModelChange)="onSearchChange($event)"
        placeholder="Buscar por nombre, apellido o correo..." />
      <lucide-angular name="search" class="pointer-events-none absolute right-4 top-1/2 -translate-y-1/2 text-zinc-400"
        [size]="20">
      </lucide-angular>
    </div>

    <!-- Dropdown Roles -->
    <div class="relative w-full md:w-64">
      <button type="button"
        class="w-full h-12 rounded-xl border border-zinc-200 bg-white px-4 text-left flex items-center justify-between hover:bg-zinc-50 focus:border-zinc-400 shadow-sm transition-colors text-zinc-600"
        (click)="toggleRoleDropdown()" aria-haspopup="listbox" [attr.aria-expanded]="isRoleOpen()">
        <span>{{ roleLabel(roleFilter()) }}</span>
        <lucide-angular name="chevron-down" class="text-zinc-400" [size]="20"></lucide-angular>
      </button>

      <div *ngIf="isRoleOpen()"
        class="absolute top-full mt-2 left-0 w-full z-50 rounded-xl border border-zinc-200 bg-white shadow-xl p-1.5 overflow-hidden animate-dropdown">
        <button *ngFor="let r of roleOptions" (click)="setRole(r)"
          class="w-full text-left px-3 py-2.5 rounded-lg text-sm transition-colors flex items-center justify-between"
          [class.bg-[var(--brand)]]="roleFilter()===r" [class.text-white]="roleFilter()===r"
          [class.text-zinc-600]="roleFilter()!==r" [class.hover:bg-zinc-50]="roleFilter()!==r">
          <span>{{ roleLabel(r) }}</span>
          <lucide-angular *ngIf="roleFilter()===r" name="check" [size]="16"></lucide-angular>
        </button>
      </div>
    </div>

    <!-- Botón crear -->
    <div>
      <button
        class="h-12 px-6 w-full md:w-auto rounded-xl bg-[var(--brand)] text-white font-medium hover:bg-opacity-90 transition-colors flex items-center justify-center gap-2 shadow-sm shadow-orange-500/20"
        (click)="openCreate()">
        <lucide-angular name="plus" [size]="18"></lucide-angular>
        <span>Nuevo Usuario</span>
      </button>
    </div>
  </div>

  <!-- Tabla -->
  <div class="rounded-2xl border border-zinc-200 bg-white shadow-sm table-responsive">
    <div class="min-w-full">
      <table class="w-full text-sm">
        <thead class="bg-zinc-50/50 border-b border-zinc-100">
          <tr class="text-left text-zinc-500">
            <th class="p-4 font-medium">Nombre</th>
            <th class="p-4 font-medium">Apellido</th>
            <th class="p-4 font-medium">Correo</th>
            <th class="p-4 font-medium">Rol</th>
            <th class="p-4 w-32 border-l border-zinc-100/50"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-zinc-100">
          <tr *ngFor="let u of paged()" class="hover:bg-zinc-50/50 transition-colors group">
            <td class="p-4 font-medium text-zinc-900">{{ u.name }}</td>
            <td class="p-4 text-zinc-600">{{ u.lastName }}</td>
            <td class="p-4 text-zinc-600">{{ u.email }}</td>
            <td class="p-4">
              <span
                class="inline-flex items-center px-4 py-1.5 rounded-full text-sm font-bold text-white shadow-sm bg-[var(--brand)]">
                {{ u.role | titlecase }}
              </span>
            </td>
            <td class="p-4 border-l border-zinc-100/50">
              <div class="flex items-center justify-end gap-2">
                <!-- Editar -->
                <button type="button"
                  class="h-8 w-8 rounded-lg flex items-center justify-center border border-zinc-200 text-zinc-400 hover:text-[var(--brand)] hover:border-[var(--brand)] hover:bg-orange-50 transition-all"
                  (click)="openEdit(u)" title="Editar">
                  <lucide-angular name="pencil" [size]="16"></lucide-angular>
                </button>
                <!-- Eliminar -->
                <button type="button"
                  class="h-8 w-8 rounded-lg flex items-center justify-center border border-zinc-200 text-zinc-400 hover:text-red-600 hover:border-red-200 hover:bg-red-50 transition-all"
                  (click)="remove(u)" title="Eliminar">
                  <lucide-angular name="trash-2" [size]="16"></lucide-angular>
                </button>
              </div>
            </td>
          </tr>

          <tr *ngIf="!loading() && paged().length === 0">
            <td class="p-12 text-center text-zinc-400" colspan="5">
              <div class="flex flex-col items-center gap-3">
                <lucide-angular name="search-x" [size]="32" class="opacity-50"></lucide-angular>
                <span>No se encontraron usuarios</span>
              </div>
            </td>
          </tr>

          <tr *ngIf="loading()">
            <td colspan="5" class="p-0">
              <div class="space-y-1">
                <div *ngFor="let i of [1,2,3,4,5,6]" class="flex items-center border-b border-zinc-50 p-4 gap-4">
                  <div class="w-1/4">
                    <ui-skeleton width="70%" height="20px"></ui-skeleton>
                  </div>
                  <div class="w-1/4">
                    <ui-skeleton width="60%" height="20px"></ui-skeleton>
                  </div>
                  <div class="w-1/3">
                    <ui-skeleton width="80%" height="20px"></ui-skeleton>
                  </div>
                  <div class="w-20">
                    <ui-skeleton width="100%" height="28px" borderRadius="14px"></ui-skeleton>
                  </div>
                  <div class="ml-auto w-16">
                    <ui-skeleton width="100%" height="20px"></ui-skeleton>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <div class="mt-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between px-1">
    <div class="text-sm text-zinc-600">
      Mostrando {{ (filtered().length === 0) ? 0 : filtered().length }} de {{ filtered().length }}
    </div>

    <div class="flex items-center gap-4">
      <button
        class="text-sm text-zinc-600 hover:text-zinc-900 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        [disabled]="!hasPrev()" (click)="prevPage()">
        Anterior
      </button>

      <div class="flex items-center gap-1">
        <button *ngFor="let i of pagesArray()" class="h-8 w-8 rounded-full text-sm font-medium transition-colors"
          [class.bg-[var(--brand)]]="page() === i" [class.text-white]="page() === i"
          [class.text-zinc-600]="page() !== i" [class.hover:bg-zinc-100]="page() !== i" (click)="goPage(i)">
          {{ i + 1 }}
        </button>
      </div>

      <button
        class="text-sm text-zinc-600 hover:text-zinc-900 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        [disabled]="!hasNext()" (click)="nextPage()">
        Siguiente
      </button>
    </div>
  </div>

  <!-- Modal crear/editar -->
  <div *ngIf="showForm()"
    class="fixed inset-0 z-50 grid place-items-center bg-black/40 backdrop-blur-sm p-4 transition-opacity animate-in fade-in duration-200">
    <div
      class="modal-box p-0 w-full max-w-2xl rounded-3xl bg-white shadow-2xl overflow-hidden pointer-events-auto relative mx-4">

      <!-- Header -->
      <div class="px-6 py-5 border-b border-zinc-100 flex items-center justify-between bg-zinc-50/50">
        <h2 class="text-lg font-bold text-zinc-800">
          {{ editingId() ? 'Editar usuario' : 'Nuevo usuario' }}
        </h2>
        <button (click)="cancelForm()" class="text-zinc-400 hover:text-zinc-600 transition-colors">
          <lucide-angular name="x" [size]="20"></lucide-angular>
        </button>
      </div>

      <!-- Body -->
      <div class="p-6 max-h-[70vh] overflow-y-auto">
        <form class="space-y-5" (submit)="$event.preventDefault()">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wide mb-1.5">Nombre</label>
              <input
                class="w-full h-11 px-4 rounded-xl border border-zinc-200 bg-white text-zinc-900 outline-none focus:border-[var(--brand)] focus:ring-1 focus:ring-[var(--brand)] transition-all placeholder:text-zinc-400"
                [(ngModel)]="f.name" name="name" required placeholder="Ej. Juan" />
            </div>
            <div>
              <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wide mb-1.5">Apellido</label>
              <input
                class="w-full h-11 px-4 rounded-xl border border-zinc-200 bg-white text-zinc-900 outline-none focus:border-[var(--brand)] focus:ring-1 focus:ring-[var(--brand)] transition-all placeholder:text-zinc-400"
                [(ngModel)]="f.lastName" name="lastName" required placeholder="Ej. Pérez" />
            </div>
          </div>

          <div>
            <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wide mb-1.5">Correo
              Electrónico</label>
            <input
              class="w-full h-11 px-4 rounded-xl border border-zinc-200 bg-white text-zinc-900 outline-none focus:border-[var(--brand)] focus:ring-1 focus:ring-[var(--brand)] transition-all placeholder:text-zinc-400"
              type="email" [(ngModel)]="f.email" name="email" required placeholder="correo@ejemplo.com" />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wide mb-1.5">Teléfono <span
                  class="font-normal normal-case text-zinc-400">(Opcional)</span></label>
              <input
                class="w-full h-11 px-4 rounded-xl border border-zinc-200 bg-white text-zinc-900 outline-none focus:border-[var(--brand)] focus:ring-1 focus:ring-[var(--brand)] transition-all placeholder:text-zinc-400"
                [(ngModel)]="f.phone" name="phone" placeholder="+503 0000 0000" />
            </div>
            <div>
              <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wide mb-1.5">
                Contraseña
                <span *ngIf="editingId()" class="font-normal normal-case text-zinc-400">(Dejar vacío para no
                  cambiar)</span>
              </label>
              <input
                class="w-full h-11 px-4 rounded-xl border border-zinc-200 bg-white text-zinc-900 outline-none focus:border-[var(--brand)] focus:ring-1 focus:ring-[var(--brand)] transition-all placeholder:text-zinc-400"
                type="password" [(ngModel)]="f.password" name="password" [required]="!editingId()"
                placeholder="••••••••" />
            </div>
          </div>

          <!-- Dropdown Rol Form -->
          <div>
            <label class="block text-xs font-bold text-zinc-500 uppercase tracking-wide mb-1.5">Rol de usuario</label>
            <div class="relative">
              <button type="button" #roleBtn
                class="w-full h-11 px-4 rounded-xl border border-zinc-200 bg-white text-left flex items-center justify-between outline-none focus:border-[var(--brand)] focus:ring-1 focus:ring-[var(--brand)] transition-all"
                (click)="toggleFormRole(roleBtn)">
                <span class="text-zinc-700">{{ formRoleLabel() }}</span>
                <lucide-angular name="chevron-down" class="text-zinc-400" [size]="20"></lucide-angular>
              </button>

              <div *ngIf="isFormRoleOpen()"
                class="absolute z-10 w-full mt-2 rounded-xl border border-zinc-200 bg-white shadow-xl p-1.5 overflow-hidden animate-dropdown"
                [ngClass]="{
                     'top-full': formRolePlacement()==='down',
                     'bottom-full mb-2': formRolePlacement()==='up'
                   }">
                <button *ngFor="let opt of formRoleOptions" (click)="pickFormRole(opt.id)" type="button"
                  class="w-full text-left px-3 py-2.5 rounded-lg text-sm transition-colors flex items-center justify-between"
                  [class.bg-[var(--brand)]]="f.roleId===opt.id" [class.text-white]="f.roleId===opt.id"
                  [class.text-zinc-600]="f.roleId!==opt.id" [class.hover:bg-zinc-50]="f.roleId!==opt.id">
                  <span>{{ opt.label }}</span>
                  <lucide-angular *ngIf="f.roleId===opt.id" name="check" [size]="16"></lucide-angular>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <div class="flex justify-end gap-3 px-6 py-4 bg-zinc-50/50 border-t border-zinc-100">
        <button type="button"
          class="px-5 h-11 rounded-full border border-zinc-200 text-zinc-600 hover:bg-zinc-50 font-medium transition-colors"
          (click)="cancelForm()">
          Cancelar
        </button>
        <button
          class="px-6 h-11 rounded-full bg-[var(--brand)] text-white hover:bg-opacity-90 font-medium shadow-md shadow-orange-500/20 transition-all disabled:opacity-70 disabled:cursor-not-allowed"
          (click)="submit()" [disabled]="loading()">
          {{ loading() ? 'Guardando...' : 'Guardar Usuario' }}
        </button>
      </div>
    </div>
  </div>
</div>